---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import BlogCard from '../../components/BlogCard.astro';
import { getCollection } from 'astro:content';
import { NO_POSTS_MESSAGE } from '../../consts';

export async function getStaticPaths() {
    const posts = await getCollection('blog', ({ data }) => {
        return data.publish !== false;
    });

    // Get all unique tags
    const tags = [...new Set(posts.flatMap(post => post.data.tags ?? []))];
    
    // Add "all" tag that shows all posts
    return [
        {
            params: { tag: 'all' },
            props: { posts, tag: 'all' }
        },
        ...tags.map(tag => ({
            params: { tag },
            props: {
                posts: posts.filter(post => post.data.tags?.includes(tag)),
                tag
            }
        }))
    ];
}

const { tag } = Astro.params;
const { posts } = Astro.props;

// Sort posts by date
const sortedPosts = [...posts].sort((a, b) => {
    const dateA = a.data.created_date ?? new Date(0);
    const dateB = b.data.created_date ?? new Date(0);
    return dateB.valueOf() - dateA.valueOf();
});

const isAllPosts = tag === 'all';
const title = isAllPosts ? 'All Posts' : `Posts tagged with #${tag}`;
const description = isAllPosts 
    ? 'Browse all articles and insights from our blog.'
    : `Browse all articles and insights related to ${tag}.`;
---

<!doctype html>
<html lang="en">
    <head>
        <BaseHead title={title} description={description} />
    </head>
    <body>
        <Header />
        <main class="container-wide page-container">
            <div class="page-header">
                <h1 class="page-title">{title}</h1>
                <p class="page-description">{description}</p>
            </div>
            {sortedPosts.length > 0 ? (
                <div class="posts-grid">
                    {sortedPosts.map((post) => (
                        <BlogCard
                            title={post.data.title}
                            description={post.data.description ?? undefined}
                            date={post.data.created_date}
                            slug={post.data.slug ?? post.id}
                            featured_image={post.data.featured_image ?? undefined}
                        />
                    ))}
                </div>
            ) : (
                <div class="no-posts">
                    {NO_POSTS_MESSAGE}
                </div>
            )}
        </main>
        <Footer />
    </body>
</html>

